#!/usr/bin/env zsh
filepaths=("$@")

if [ -z "${filepaths[*]}" ]; then
  return 1
fi

realpaths=()

for filepath in "${filepaths[@]}"; do
  # Expand `~` because bat can't expand it.
  realpaths+=("${filepath/#\~/${HOME}}")
done

if [ "${#filepaths}" = "1" ]; then
  parts=("${(s;:;)realpaths[1]}")
  realpath="${parts[1]}"
  lineno="${parts[2]}"

  if [ -z "${lineno}" ]; then
    lineno="0"
  fi

  bat_options=(
    --highlight-line "${lineno}"
  )

  case "${realpath}" in
    *Gemfile.local* | *.jb | */pryrc)
      bat_options+=(--language "ruby")
      ;;
  esac

  case "${realpath}" in
    *.csv)
      if command -v nkf > /dev/null; then
        nkf "${realpath}" | bat "${bat_options[@]}" --file-name "${realpath}"
      else
        bat "${realpath}" "${bat_options[@]}"
      fi
      ;;
    *.diff)
      if command -v delta > /dev/null; then
        delta < "${realpath}"
      else
        bat "${realpath}" "${bat_options[@]}"
      fi
      ;;
    *)
      bat "${realpath}" "${bat_options[@]}"
  esac
else
  bat "${realpaths[@]}"
fi
